<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sete Soluções Fiscais - Calendário de Vencimentos</title>

  <!-- Tailwind (ok para agora; em produção ideal é build/CLI) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>

  <!-- jsPDF + AutoTable (para exportar) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js" defer></script>

  <!-- Suas credenciais Firebase -->
  <script src="config.js"></script>

  <style>
    :root {
      --brand-blue: #1F2D5A;
      --brand-gold: #E8A021;
      --brand-green: #10B981;
      --brand-red: #EF4444;
    }
    body { font-family: 'Poppins', sans-serif; background-color: #f8f9fa; }
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      background-color: #e9ecef;
    }
    .calendar-day.today { background-color: #f1f3f5; }
    .calendar-day:hover { background-color: #e9ecef; }
    .events-container { flex-grow: 1; overflow-y: auto; padding: 4px; }
    .events-container::-webkit-scrollbar { width: 5px; }
    .events-container::-webkit-scrollbar-thumb { background-color: #ced4da; border-radius: 20px; }
    .event-item {
      font-size: 0.8rem;
      padding: 6px 10px;
      border-radius: 6px;
      margin-bottom: 6px;
      cursor: pointer;
      transition: all 0.2s;
      border-left: 4px solid;
      word-break: break-word;
      position: relative;
    }
    .delete-icon {
      position: absolute; top: 50%; right: 8px; transform: translateY(-50%);
      width: 20px; height: 20px; border-radius: 50%;
      background-color: rgba(0,0,0,0.05); color: #868e96;
      display: flex; align-items: center; justify-content: center;
      font-size: 14px; font-weight: bold; cursor: pointer; opacity: 0;
      transition: all 0.2s; line-height: 1;
    }
    .event-item:hover .delete-icon { opacity: 1; }
    .delete-icon:hover { background-color: #e63946; color: white; transform: translateY(-50%) scale(1.1); }
    .event-pendente { background-color: #fdf2e1; color: #8c5a03; border-left-color: var(--brand-gold); }
    .event-pago { background-color: #D1FAE5; color: #065F46; border-left-color: var(--brand-green); }
    .event-em_atraso { background-color: #FEE2E2; color: #991B1B; border-left-color: var(--brand-red); }
    .modal-backdrop {
      position: fixed; inset: 0; background-color: rgba(31, 45, 90, 0.6);
      display: flex; justify-content: center; align-items: center;
      z-index: 50; backdrop-filter: blur(4px);
    }
    .modal-content {
      background-color: white; border-radius: 0.75rem;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      width: 90%; max-width: 550px; overflow: hidden;
    }
    .modal-header { background-color: var(--brand-blue); color: white; padding: 1rem 1.5rem; }
    .form-input, .form-select { background-color: #f8f9fa; border-color: #dee2e6; }
    .form-input:focus, .form-select:focus { --tw-ring-color: var(--brand-gold); border-color: var(--brand-gold); }
    .btn { transition: all 0.2s; transform: translateY(0); }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
    .btn-primary { background-color: var(--brand-blue); color: white; }
    .btn-accent { background-color: var(--brand-gold); color: var(--brand-blue); }
  </style>
</head>

<body class="antialiased text-gray-800">
  <div id="app" class="max-w-screen-2xl mx-auto p-4 sm:p-6 lg:p-8 opacity-0 transition-opacity duration-500">
    <div id="view-only-banner" class="hidden bg-yellow-200 text-yellow-800 text-center p-2 rounded-lg mb-4">
      <strong>Modo Consulta:</strong> Apenas visualização permitida.
    </div>

    <div id="export-area">
      <header class="flex flex-col sm:flex-row justify-between items-center mb-8">
        <div class="w-full sm:text-left text-center">
          <h1 class="text-3xl sm:text-4xl font-bold" style="color: var(--brand-blue);">Sete Soluções Fiscais</h1>
          <div class="mt-2">
            <label for="calendar-title-input" class="sr-only">Título do Calendário</label>
            <input id="calendar-title-input" type="text" placeholder="Calendário de Impostos"
                   class="form-input w-full sm:w-1/2 text-lg p-1 border-gray-300 rounded bg-transparent focus:bg-white"
                   style="color: var(--brand-gold);" />
          </div>
        </div>
        <div class="flex items-center space-x-3 mt-4 sm:mt-0 flex-shrink-0" id="header-buttons">
          <button id="share-btn" class="btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md">Partilhar</button>
          <button id="export-pdf-btn" class="btn btn-accent font-bold py-2 px-4 rounded-lg shadow-md">Exportar</button>
          <button id="add-event-btn" class="btn btn-primary font-bold py-2 px-4 rounded-lg shadow-md">Adicionar</button>
          <button id="fork-calendar-btn" class="btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">Gerar link desta edição</button>
        </div>
      </header>

      <div class="bg-white p-4 rounded-xl shadow-sm mb-6 border border-gray-200">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
          <div>
            <label for="client-name-input" class="block text-sm font-medium text-gray-600 mb-1">Nome do Cliente:</label>
            <input id="client-name-input" type="text" placeholder="Digite o nome do cliente" class="form-input w-full py-2 px-3 rounded-md border"/>
          </div>
          <div>
            <label for="client-cnpj-input" class="block text-sm font-medium text-gray-600 mb-1">CNPJ:</label>
            <input id="client-cnpj-input" type="text" placeholder="00.000.000/0001-00" class="form-input w-full py-2 px-3 rounded-md border"/>
          </div>
        </div>
      </div>

      <div id="summary-dashboard" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 text-center">
          <h4 class="text-sm font-semibold text-gray-500">Total a Pagar no Mês</h4>
          <p id="summary-total" class="text-2xl font-bold" style="color: var(--brand-blue);"></p>
        </div>
        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 text-center">
          <h4 class="text-sm font-semibold text-gray-500">Total Pago</h4>
          <p id="summary-paid" class="text-2xl font-bold" style="color: var(--brand-green);"></p>
        </div>
        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 text-center">
          <h4 class="text-sm font-semibold text-gray-500">Total Pendente</h4>
          <p id="summary-pending" class="text-2xl font-bold" style="color: var(--brand-red);"></p>
        </div>
      </div>

      <div class="flex justify-between items-center mb-4 bg-white p-3 rounded-xl shadow-sm border border-gray-200">
        <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-200 text-gray-600">◀</button>
        <h2 id="current-month-year" class="text-xl font-semibold text-center" style="color: var(--brand-blue);"></h2>
        <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-200 text-gray-600">▶</button>
      </div>

      <div id="calendar-container" class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-200">
        <div class="grid grid-cols-7 text-center font-semibold p-3 border-b border-gray-200"
             style="background-color: var(--brand-blue); color: white;">
          <div>Dom</div><div>Seg</div><div>Ter</div><div>Qua</div><div>Qui</div><div>Sex</div><div>Sáb</div>
        </div>
        <div id="calendar-grid" class="calendar-grid"></div>
      </div>
    </div>

    <div id="loading-spinner" class="hidden fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-50">
      <div class="flex flex-col items-center bg-white p-8 rounded-lg shadow-xl">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4" style="border-color: var(--brand-gold);"></div>
        <p id="loading-text" class="mt-4 text-lg font-semibold text-gray-700">Aguarde...</p>
      </div>
    </div>
  </div>

  <div id="modal-container"></div>

  <script type="module">
    // Firebase Imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";

    // --- CONFIGURAÇÃO ---
    const PUBLIC_URL = ''; // usa domínio atual

    // --- Firebase Setup ---
    const firebaseConfig = typeof window.__firebase_config !== 'undefined'
      ? JSON.parse(window.__firebase_config)
      : { apiKey: "DEMO", authDomain: "DEMO", projectId: "DEMO" };

    const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-app-id';
    const initialAuthToken = typeof window.__initial_auth_token !== 'undefined' ? window.__initial_auth_token : null;

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    try { window.appAnalytics = getAnalytics(app); } catch (e) { console.warn("Analytics indisponível:", e?.message); }

    // Logs de diagnóstico
    console.log("[CALEN] __firebase_config present:", typeof window.__firebase_config !== 'undefined');
    if (typeof window.__firebase_config !== 'undefined') {
      try { const cfg = JSON.parse(window.__firebase_config); console.log("[CALEN] projectId:", cfg.projectId); }
      catch (e) { console.warn("[CALEN] config parse error", e); }
    }
    console.log("[CALEN] PUBLIC_URL:", PUBLIC_URL || "<empty>");

    document.addEventListener('DOMContentLoaded', () => {
      let currentDate = new Date();
      let state = { appInfo: { name: '', cnpj: '', calendarTitle: 'Calendário de Impostos' }, events: [] };
      let calendarId = null;
      let isViewOnly = false;
      let saveTimeout;
      let eventIdToDelete = null;

      const appEl = document.getElementById('app');
      const calendarGrid = document.getElementById('calendar-grid');
      const currentMonthYearEl = document.getElementById('current-month-year');
      const prevMonthBtn = document.getElementById('prev-month-btn');
      const nextMonthBtn = document.getElementById('next-month-btn');
      const addEventBtn = document.getElementById('add-event-btn');
      const exportPdfBtn = document.getElementById('export-pdf-btn');
      const shareBtn = document.getElementById('share-btn');
      const forkCalendarBtn = document.getElementById('fork-calendar-btn');
      const loadingSpinner = document.getElementById('loading-spinner');
      const loadingText = document.getElementById('loading-text');
      const clientNameInput = document.getElementById('client-name-input');
      const clientCnpjInput = document.getElementById('client-cnpj-input');
      const calendarTitleInput = document.getElementById('calendar-title-input');
      const modalContainer = document.getElementById('modal-container');
      const viewOnlyBanner = document.getElementById('view-only-banner');
      const summaryTotalEl = document.getElementById('summary-total');
      const summaryPaidEl = document.getElementById('summary-paid');
      const summaryPendingEl = document.getElementById('summary-pending');

      const getBaseUrl = () => (PUBLIC_URL || window.location.href).split('?')[0];

      const parseCurrency = (str) => {
        if (typeof str !== 'string' || !str) return 0;
        const cleaned = str.replace(/[^\d,]/g, '').replace(',', '.');
        return parseFloat(cleaned) || 0;
      };

      const formatCurrency = (value) => {
        const n = parseFloat(value);
        if (isNaN(n)) return 'R$ 0,00';
        return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(n);
      };

      const showLoading = (text = 'Aguarde...') => { loadingText.textContent = text; loadingSpinner.classList.remove('hidden'); };
      const hideLoading = () => loadingSpinner.classList.add('hidden');

      const saveData = async () => {
        if (isViewOnly || !calendarId) return;
        try {
          const ref = doc(db, "artifacts", appId, "public/data/calendars", calendarId);
          await setDoc(ref, { ...state, updatedAt: serverTimestamp() }, { merge: true });
        } catch (err) {
          console.error("Error saving data:", err);
          alert("Ocorreu um erro ao guardar os dados.");
        }
      };
      const debouncedSave = () => { clearTimeout(saveTimeout); saveTimeout = setTimeout(saveData, 600); };

      const loadAppInfo = () => {
        clientNameInput.value = state.appInfo.name;
        clientCnpjInput.value = state.appInfo.cnpj;
        calendarTitleInput.value = state.appInfo.calendarTitle;
      };
      const updateAppInfo = () => {
        state.appInfo.name = clientNameInput.value;
        state.appInfo.cnpj = clientCnpjInput.value;
        state.appInfo.calendarTitle = calendarTitleInput.value;
        debouncedSave();
      };

      const updateSummary = () => {
        const m = currentDate.getMonth(), y = currentDate.getFullYear();
        const monthEvents = state.events.filter(e => {
          const d = new Date(e.date);
          return d.getMonth() === m && d.getFullYear() === y;
        });
        const total = monthEvents.reduce((s, e) => s + parseFloat(e.value), 0);
        const paid = monthEvents.filter(e => e.status === 'pago').reduce((s, e) => s + parseFloat(e.value), 0);
        const pending = total - paid;
        summaryTotalEl.textContent = formatCurrency(total);
        summaryPaidEl.textContent = formatCurrency(paid);
        summaryPendingEl.textContent = formatCurrency(pending);
      };

      const renderCalendar = () => {
        calendarGrid.innerHTML = '';
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const today = new Date(); today.setHours(0,0,0,0);
        currentMonthYearEl.textContent = `${currentDate.toLocaleDateString('pt-BR', { month: 'long' })} de ${year}`;

        const firstDay = new Date(year, month, 1).getDay();
        const lastDate = new Date(year, month + 1, 0).getDate();

        for (let i = firstDay; i > 0; i--) {
          calendarGrid.innerHTML += `<div class="p-2 bg-gray-100 border-t border-l border-gray-200"></div>`;
        }

        for (let i = 1; i <= lastDate; i++) {
          const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
          const isToday = new Date(dateStr).getTime() === today.getTime();
          const dayEl = document.createElement('div');
          dayEl.className = 'calendar-day p-2 border-t border-l border-gray-200';
          dayEl.dataset.date = dateStr;

          const dayNumberEl = document.createElement('div');
          dayNumberEl.className = 'text-sm font-semibold text-right mb-1';
          dayNumberEl.innerHTML = `<span class="${isToday ? 'bg-[var(--brand-blue)] text-white rounded-full w-7 h-7 flex items-center justify-center float-right' : 'text-gray-500'}">${i}</span>`;
          dayEl.appendChild(dayNumberEl);

          const dayEvents = state.events.filter(e => e.date === dateStr).sort((a,b) => a.taxName.localeCompare(b.taxName));
          if (dayEvents.length > 0) {
            const eventsContainer = document.createElement('div');
            eventsContainer.className = 'events-container space-y-1';
            dayEvents.forEach(event => {
              const eventEl = document.createElement('div');
              let statusClass = 'event-pendente';
              const eventDate = new Date(event.date + 'T00:00:00');
              if (event.status === 'pago') statusClass = 'event-pago';
              else if (event.status === 'pendente' && eventDate < today) statusClass = 'event-em_atraso';

              eventEl.className = `event-item ${statusClass}`;
              eventEl.dataset.eventId = event.id;
              eventEl.innerHTML = `
                <span class="delete-icon" data-delete-id="${event.id}">×</span>
                <strong class="block text-sm pr-4">${event.taxName}</strong>
                <span class="text-xs">${event.title || ''}</span>
                <span class="block text-xs font-semibold mt-1">${formatCurrency(event.value)}</span>
              `;
              eventsContainer.appendChild(eventEl);
            });
            dayEl.appendChild(eventsContainer);
          }

          calendarGrid.appendChild(dayEl);
        }

        const remaining = 42 - (firstDay + lastDate);
        for (let i = 1; i <= remaining; i++) {
          calendarGrid.innerHTML += `<div class="p-2 bg-gray-100 border-t border-l border-gray-200"></div>`;
        }
        updateSummary();
      };

      const renderModal = (type, props = {}) => {
        modalContainer.innerHTML = '';
        let html = '';
        if (type === 'event') {
          html = `
            <div id="event-modal" class="modal-backdrop">
              <div class="modal-content p-0">
                <div class="modal-header"><h3 class="text-2xl font-bold">${props.isEdit ? 'Editar Vencimento' : 'Adicionar Vencimento'}</h3></div>
                <form id="event-form" class="p-6 space-y-4">
                  <input type="hidden" id="event-id" value="${props.event?.id || ''}">
                  <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Nome da Obrigação:</label>
                    <input type="text" id="event-tax-name" class="form-input shadow-sm w-full" value="${props.event?.taxName || ''}" required>
                  </div>
                  <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Título/Descrição:</label>
                    <input type="text" id="event-title" class="form-input shadow-sm w-full" value="${props.event?.title || ''}" placeholder="Ex.: Guia de ICMS">
                  </div>
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                      <label class="block text-gray-700 text-sm font-bold mb-2">Data:</label>
                      <input type="date" id="event-date" class="form-input shadow-sm w-full" value="${props.date || props.event?.date || ''}" required>
                    </div>
                    <div>
                      <label class="block text-gray-700 text-sm font-bold mb-2">Valor (R$):</label>
                      <input type="text" inputmode="decimal" id="event-value" class="form-input shadow-sm w-full" value="${props.event ? String(props.event.value).replace('.', ',') : ''}" required>
                    </div>
                  </div>
                  <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Estado:</label>
                    <select id="event-status" class="form-select shadow-sm w-full">
                      <option value="pendente" ${props.event?.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                      <option value="pago" ${props.event?.status === 'pago' ? 'selected' : ''}>Pago</option>
                    </select>
                  </div>
                  <div class="flex items-center justify-end space-x-3 pt-4">
                    ${props.isEdit ? `<button type="button" id="delete-event-btn" class="btn bg-red-600 text-white px-3 py-2 rounded">Excluir</button>` : ''}
                    <button type="button" id="cancel-btn" class="btn bg-gray-400 text-white px-3 py-2 rounded">Cancelar</button>
                    <button type="submit" class="btn btn-primary px-3 py-2 rounded">Salvar</button>
                  </div>
                </form>
              </div>
            </div>`;
        } else if (type === 'confirm') {
          html = `
            <div id="confirm-modal" class="modal-backdrop">
              <div class="modal-content p-0">
                <div class="modal-header"><h3 class="text-xl font-bold">Confirmar Exclusão</h3></div>
                <div class="p-6">
                  <p class="text-gray-600 mb-6">Tem certeza de que deseja excluir este evento?</p>
                  <div class="flex items-center justify-end space-x-3">
                    <button type="button" id="confirm-cancel-btn" class="btn bg-gray-400 text-white px-3 py-2 rounded">Cancelar</button>
                    <button type="button" id="confirm-delete-btn" class="btn bg-red-600 text-white px-3 py-2 rounded">Excluir</button>
                  </div>
                </div>
              </div>
            </div>`;
        } else if (type === 'share') {
          html = `
            <div id="share-modal" class="modal-backdrop">
              <div class="modal-content p-0">
                <div class="modal-header"><h3 class="text-xl font-bold">Partilhar Calendário</h3></div>
                <div class="p-6 space-y-4">
                  <p class="text-gray-600">Envie o link abaixo. O cliente terá acesso somente leitura.</p>
                  <input type="text" id="share-link-input" value="${props.shareLink}" readonly class="form-input w-full bg-gray-200 cursor-pointer">
                  <div class="flex items-center justify-end space-x-3">
                    <button type="button" id="copy-link-btn" class="btn btn-primary px-3 py-2 rounded">Copiar Link</button>
                    <button type="button" id="close-share-btn" class="btn bg-gray-400 text-white px-3 py-2 rounded">Fechar</button>
                  </div>
                </div>
              </div>
            </div>`;
        } else if (type === 'newCalendarInfo') {
          html = `
            <div id="new-calendar-modal" class="modal-backdrop">
              <div class="modal-content p-0">
                <div class="modal-header"><h3 class="text-xl font-bold">Calendário Criado</h3></div>
                <div class="p-6 space-y-4">
                  <p class="text-gray-600"><strong>Importante:</strong> guarde o link de edição.</p>
                  <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Link de Edição:</label>
                    <div class="flex space-x-2">
                      <input type="text" id="edit-link-input" value="${props.editLink}" readonly class="form-input w-full bg-gray-200">
                      <button type="button" id="copy-edit-link-btn" class="btn btn-primary px-3 py-2 rounded">Copiar</button>
                    </div>
                  </div>
                  <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Link de Partilha:</label>
                    <div class="flex space-x-2">
                      <input type="text" id="share-link-input-new" value="${props.viewLink}" readonly class="form-input w-full bg-gray-200">
                      <button type="button" id="copy-share-link-btn" class="btn btn-primary px-3 py-2 rounded">Copiar</button>
                    </div>
                  </div>
                  <div class="flex items-center justify-end">
                    <button type="button" id="close-new-calendar-btn" class="btn btn-accent px-3 py-2 rounded">Continuar</button>
                  </div>
                </div>
              </div>
            </div>`;
        }
        modalContainer.innerHTML = html;
        attachModalEventListeners(type);
      };

      const attachModalEventListeners = (type) => {
        const closeModal = () => modalContainer.innerHTML = '';
        if (type === 'event') {
          document.getElementById('event-form').addEventListener('submit', handleEventFormSubmit);
          document.getElementById('cancel-btn').addEventListener('click', closeModal);
          const del = document.getElementById('delete-event-btn');
          if (del) del.addEventListener('click', () => { eventIdToDelete = document.getElementById('event-id').value; closeModal(); renderModal('confirm'); });
        } else if (type === 'confirm') {
          document.getElementById('confirm-delete-btn').addEventListener('click', () => {
            if (eventIdToDelete) { state.events = state.events.filter(e => e.id !== eventIdToDelete); debouncedSave(); renderCalendar(); }
            eventIdToDelete = null; closeModal();
          });
          document.getElementById('confirm-cancel-btn').addEventListener('click', closeModal);
        } else if (type === 'share') {
          const copyBtn = document.getElementById('copy-link-btn');
          const linkInput = document.getElementById('share-link-input');
          copyBtn.addEventListener('click', async () => {
            try { await navigator.clipboard.writeText(linkInput.value); copyBtn.textContent = 'Copiado!'; setTimeout(()=>copyBtn.textContent='Copiar Link',2000); }
            catch { linkInput.select(); document.execCommand('copy'); copyBtn.textContent='Copiado!'; setTimeout(()=>copyBtn.textContent='Copiar Link',2000); }
          });
          document.getElementById('close-share-btn').addEventListener('click', closeModal);
        } else if (type === 'newCalendarInfo') {
          document.getElementById('close-new-calendar-btn').addEventListener('click', closeModal);
          const copyEdit = document.getElementById('copy-edit-link-btn');
          const editInput = document.getElementById('edit-link-input');
          copyEdit.addEventListener('click', async () => {
            try { await navigator.clipboard.writeText(editInput.value); copyEdit.textContent='Copiado!'; setTimeout(()=>copyEdit.textContent='Copiar',2000); }
            catch { editInput.select(); document.execCommand('copy'); copyEdit.textContent='Copiado!'; setTimeout(()=>copyEdit.textContent='Copiar',2000); }
          });
          const copyShare = document.getElementById('copy-share-link-btn');
          const shareInput = document.getElementById('share-link-input-new');
          copyShare.addEventListener('click', async () => {
            try { await navigator.clipboard.writeText(shareInput.value); copyShare.textContent='Copiado!'; setTimeout(()=>copyShare.textContent='Copiar',2000); }
            catch { shareInput.select(); document.execCommand('copy'); copyShare.textContent='Copiado!'; setTimeout(()=>copyShare.textContent='Copiar',2000); }
          });
        }
        const backdrop = modalContainer.querySelector('.modal-backdrop');
        if (backdrop) backdrop.addEventListener('click', (e)=>{ if(e.target===backdrop) closeModal(); });
      };

      const handleEventFormSubmit = (e) => {
        e.preventDefault();
        const id = document.getElementById('event-id').value;
        const newEvent = {
          id: id || `${Date.now()}-${Math.random()}`,
          taxName: document.getElementById('event-tax-name').value,
          title: document.getElementById('event-title').value,
          date: document.getElementById('event-date').value,
          value: parseCurrency(document.getElementById('event-value').value),
          status: document.getElementById('event-status').value,
        };
        if (id) state.events = state.events.map(ev => ev.id === id ? newEvent : ev);
        else state.events.push(newEvent);
        debouncedSave(); renderCalendar(); modalContainer.innerHTML = '';
      };

      calendarGrid.addEventListener('click', (e) => {
        if (isViewOnly) return;
        const target = e.target;
        if (target.classList.contains('delete-icon')) { e.stopPropagation(); eventIdToDelete = target.dataset.deleteId; renderModal('confirm'); }
        else if (target.closest('.event-item')) { e.stopPropagation(); const ev = state.events.find(x => x.id === target.closest('.event-item').dataset.eventId); renderModal('event', { isEdit: true, event: ev }); }
        else if (target.closest('.calendar-day')) { renderModal('event', { isEdit: false, date: target.closest('.calendar-day').dataset.date }); }
      });

      prevMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); });
      nextMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); });
      addEventBtn.addEventListener('click', () => renderModal('event', { isEdit: false, date: new Date().toISOString().split('T')[0] }));

      shareBtn.addEventListener('click', () => {
        const baseUrl = getBaseUrl();
        const viewLink = `${baseUrl}?view=${calendarId}`;
        renderModal('share', { shareLink: viewLink });
      });

      forkCalendarBtn.addEventListener('click', async () => {
        showLoading('A gerar link desta edição...');
        try {
          const newDocRef = await addDoc(collection(db, "artifacts", appId, "public/data/calendars"), {
            ...state, parentId: calendarId || null, forkedFrom: calendarId || null, forkedAt: serverTimestamp(), createdAt: serverTimestamp()
          });
          const newId = newDocRef.id;
          const baseUrl = getBaseUrl();
          const editLink = `${baseUrl}?id=${newId}`;
          const viewLink = `${baseUrl}?view=${newId}`;
          hideLoading();
          renderModal('newCalendarInfo', { editLink, viewLink });
        } catch (error) {
          console.error('Erro ao gerar link da edição:', error);
          hideLoading();
          alert('Não foi possível gerar o link desta edição.');
        }
      });

      exportPdfBtn.addEventListener('click', () => {
        showLoading('A gerar PDF...');
        const { jsPDF } = window.jspdf;
        const docPdf = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
        const head = [['Data', 'Obrigação', 'Estado', 'Valor']];
        const body = state.events
          .filter(e => new Date(e.date).getMonth() === currentDate.getMonth() && new Date(e.date).getFullYear() === currentDate.getFullYear())
          .sort((a,b) => new Date(a.date) - new Date(b.date))
          .map(e => {
            const today = new Date(); today.setHours(0,0,0,0);
            const eventDate = new Date(e.date + 'T00:00:00');
            let statusText = 'Pendente';
            if (e.status === 'pago') statusText = 'Pago';
            else if (eventDate < today) statusText = 'Em Atraso';
            return [ eventDate.toLocaleDateString('pt-BR'), e.taxName, statusText, formatCurrency(e.value) ];
          });

        const pageWidth = docPdf.internal.pageSize.getWidth();
        const margin = 15;

        docPdf.setFont('helvetica', 'bold'); docPdf.setFontSize(16); docPdf.setTextColor(31,45,90);
        docPdf.text('Sete Soluções Fiscais', pageWidth/2, margin, { align: 'center' });
        docPdf.setFont('helvetica', 'normal'); docPdf.setFontSize(12); docPdf.setTextColor(232,160,33);
        docPdf.text(state.appInfo.calendarTitle, pageWidth/2, margin+7, { align: 'center' });
        docPdf.setFontSize(10); docPdf.setTextColor(100,116,139);
        docPdf.text(`Cliente: ${state.appInfo.name || 'Não informado'}`, pageWidth/2, margin+14, { align: 'center' });
        docPdf.text(`CNPJ: ${state.appInfo.cnpj || 'Não informado'}`, pageWidth/2, margin+19, { align: 'center' });

        docPdf.autoTable({
          head, body, startY: margin+25, theme: 'grid',
          headStyles: { fillColor: [31,45,90], textColor: [255,255,255] },
          styles: { font: 'helvetica', fontSize: 9 }, columnStyles: { 3: { halign: 'right' } }
        });

        const now = new Date();
        docPdf.setFontSize(8); docPdf.setTextColor(150,150,150);
        docPdf.text(`Exportado em: ${now.toLocaleDateString('pt-BR')} às ${now.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'})}`,
          pageWidth/2, docPdf.internal.pageSize.getHeight()-10, { align: 'center' });

        const monthYear = currentMonthYearEl.textContent.replace(' de ', '_');
        const clientName = (state.appInfo.name || '').replace(/ /g, '_') || 'cliente';
        docPdf.save(`Calendario_${clientName}_${monthYear}.pdf`);
        hideLoading();
      });

      const init = async () => {
        showLoading('A autenticar...');
        try {
          if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
          else await signInAnonymously(auth);
        } catch (error) {
          console.error("Authentication failed:", error);
          alert("Falha na autenticação. A aplicação poderá não funcionar corretamente.");
        }

        showLoading('A carregar dados...');
        const params = new URLSearchParams(window.location.search);
        const viewId = params.get('view');
        let editId = params.get('id');

        if (viewId) { calendarId = viewId; isViewOnly = true; }
        else { calendarId = editId; }

        if (calendarId) {
          try {
            const ref = doc(db, "artifacts", appId, "public/data/calendars", calendarId);
            const snap = await getDoc(ref);
            if (snap.exists()) {
              const data = snap.data();
              state.appInfo = data.appInfo || state.appInfo;
              state.events = data.events || [];
            } else {
              if (isViewOnly) { alert("Calendário não encontrado."); hideLoading(); return; }
              await saveData();
            }
          } catch (error) {
            console.error("Error loading data:", error);
            alert("Não foi possível carregar os dados do calendário.");
            isViewOnly = true;
          }
        } else {
          try {
            const newDocRef = await addDoc(collection(db, "artifacts", appId, "public/data/calendars"), { ...state, createdAt: serverTimestamp() });
            calendarId = newDocRef.id;
            const baseUrl = getBaseUrl();
            renderModal('newCalendarInfo', { editLink: `${baseUrl}?id=${calendarId}`, viewLink: `${baseUrl}?view=${calendarId}` });
          } catch (error) {
            console.error("Error creating new calendar:", error);
            alert("Não foi possível criar um novo calendário.");
            isViewOnly = true;
          }
        }

        loadAppInfo(); renderCalendar();

        if (isViewOnly) {
          document.querySelectorAll('input, select, button').forEach(el => el.disabled = true);
          document.getElementById('header-buttons').style.display = 'none';
          viewOnlyBanner.classList.remove('hidden');
          calendarGrid.style.cursor = 'default';
        } else {
          clientNameInput.addEventListener('input', updateAppInfo);
          clientCnpjInput.addEventListener('input', updateAppInfo);
          calendarTitleInput.addEventListener('input', updateAppInfo);
        }

        hideLoading();
        appEl.classList.remove('opacity-0');
      };

      init();
    });
  </script>
</body>
</html>
